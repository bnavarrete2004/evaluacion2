{% extends 'api_clinica/base.html' %}

{% block title %}Médicos - {{ block.super }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Gestión de Médicos</h5>
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#medicoModal" data-mode="create">
                    <i class="fas fa-plus-circle me-2"></i>Nuevo Médico
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div class="d-flex">
                        <label for="filterEspecialidad" class="form-label me-2 mb-0 align-self-center">Filtrar por Especialidad:</label>
                        <select class="form-select me-2" id="filterEspecialidad" style="width: 200px;">
                            <option value="">Todas</option>
                            <!-- Opciones de especialidad se cargarán aquí -->
                        </select>
                        <label for="filterActivo" class="form-label me-2 mb-0 align-self-center">Estado:</label>
                        <select class="form-select me-2" id="filterActivo" style="width: 120px;">
                            <option value="">Todos</option>
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                        <button class="btn btn-primary" type="button" id="applyFiltersButton">Aplicar Filtros</button>
                    </div>
                    <div class="input-group w-25">
                        <input type="text" class="form-control" id="searchInput" placeholder="Buscar por nombre, RUT, correo...">
                        <button class="btn btn-primary" type="button" id="searchButton">Buscar</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre Completo</th>
                                <th>RUT</th>
                                <th>Correo</th>
                                <th>Teléfono</th>
                                <th>Especialidad</th>
                                <th>Activo</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="medicosTableBody">
                            <!-- Los datos se cargarán aquí con JavaScript -->
                            <tr>
                                <td colspan="8" class="text-center">Cargando médicos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear/Editar Médico -->
<div class="modal fade" id="medicoModal" tabindex="-1" aria-labelledby="medicoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="medicoModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="medicoForm">
                    <input type="hidden" id="medicoId">
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="apellido" class="form-label">Apellido</label>
                        <input type="text" class="form-control" id="apellido" name="apellido" required>
                    </div>
                    <div class="mb-3">
                        <label for="rut" class="form-label">RUT</label>
                        <input type="text" class="form-control" id="rut" name="rut" required>
                    </div>
                    <div class="mb-3">
                        <label for="correo" class="form-label">Correo</label>
                        <input type="email" class="form-control" id="correo" name="correo" required>
                    </div>
                    <div class="mb-3">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <input type="text" class="form-control" id="telefono" name="telefono">
                    </div>
                    <div class="mb-3">
                        <label for="especialidad" class="form-label">Especialidad</label>
                        <select class="form-select" id="especialidad" name="especialidad" required>
                            <!-- Opciones de especialidad se cargarán aquí -->
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="activo" name="activo">
                        <label class="form-check-label" for="activo">Activo</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="medicoForm" class="btn btn-primary" id="saveMedicoBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const API_BASE_URL = '/api/medicos/';
    const ESPECIALIDADES_API_URL = '/api/especialidades/';
    const medicosTableBody = document.getElementById('medicosTableBody');
    const medicoModal = new bootstrap.Modal(document.getElementById('medicoModal'));
    const medicoModalLabel = document.getElementById('medicoModalLabel');
    const medicoForm = document.getElementById('medicoForm');
    const medicoIdInput = document.getElementById('medicoId');
    const nombreInput = document.getElementById('nombre');
    const apellidoInput = document.getElementById('apellido');
    const rutInput = document.getElementById('rut');
    const correoInput = document.getElementById('correo');
    const telefonoInput = document.getElementById('telefono');
    const especialidadSelect = document.getElementById('especialidad');
    const activoCheckbox = document.getElementById('activo');
    const saveMedicoBtn = document.getElementById('saveMedicoBtn');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const filterEspecialidadSelect = document.getElementById('filterEspecialidad');
    const filterActivoSelect = document.getElementById('filterActivo');
    const applyFiltersButton = document.getElementById('applyFiltersButton');

    let currentMode = 'create';
    let currentMedicoId = null;

    /**
     * @brief Carga las especialidades para el filtro y el formulario.
     */
    async function loadEspecialidadesForSelects() {
        try {
            const response = await axios.get(ESPECIALIDADES_API_URL);
            const especialidades = response.data;

            // Limpiar y poblar select del formulario
            especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
            // Limpiar y poblar select del filtro
            filterEspecialidadSelect.innerHTML = '<option value="">Todas</option>';

            especialidades.forEach(esp => {
                const optionForm = document.createElement('option');
                optionForm.value = esp.id;
                optionForm.textContent = esp.nombre;
                especialidadSelect.appendChild(optionForm);

                const optionFilter = document.createElement('option');
                optionFilter.value = esp.id;
                optionFilter.textContent = esp.nombre;
                filterEspecialidadSelect.appendChild(optionFilter);
            });
        } catch (error) {
            console.error('Error al cargar especialidades:', error);
            alert('Error al cargar las especialidades para los selectores.');
        }
    }

    /**
     * @brief Carga los médicos desde la API y los renderiza en la tabla.
     * @param {object} filters - Objeto con filtros para la API.
     */
    async function loadMedicos(filters = {}) {
        try {
            let url = API_BASE_URL;
            const params = new URLSearchParams();
            if (filters.search) params.append('search', filters.search);
            if (filters.especialidad) params.append('especialidad', filters.especialidad);
            if (filters.activo !== undefined && filters.activo !== null) params.append('activo', filters.activo);

            if (params.toString()) {
                url += `?${params.toString()}`;
            }

            const response = await axios.get(url);
            const medicos = response.data;
            renderMedicos(medicos);
        } catch (error) {
            console.error('Error al cargar médicos:', error);
            medicosTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Error al cargar los médicos.</td></tr>`;
        }
    }

    /**
     * @brief Renderiza la lista de médicos en la tabla HTML.
     * @param {Array} medicos - Lista de objetos de médico.
     */
    function renderMedicos(medicos) {
        medicosTableBody.innerHTML = '';
        if (medicos.length === 0) {
            medicosTableBody.innerHTML = `<tr><td colspan="8" class="text-center">No hay médicos registrados.</td></tr>`;
            return;
        }
        medicos.forEach(medico => {
            const row = medicosTableBody.insertRow();
            row.innerHTML = `
                <td>${medico.id}</td>
                <td>${medico.nombre} ${medico.apellido}</td>
                <td>${medico.rut}</td>
                <td>${medico.correo || 'N/A'}</td>
                <td>${medico.telefono || 'N/A'}</td>
                <td>${medico.especialidad_nombre || 'N/A'}</td>
                <td>${medico.activo ? '<span class="badge bg-success">Sí</span>' : '<span class="badge bg-danger">No</span>'}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-info text-white me-2 edit-btn" data-id="${medico.id}" data-bs-toggle="modal" data-bs-target="#medicoModal" data-mode="edit">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="${medico.id}">
                        <i class="fas fa-trash-alt"></i> Eliminar
                    </button>
                </td>
            `;
        });

        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', handleEditClick);
        });
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', handleDeleteClick);
        });
    }

    /**
     * @brief Maneja el clic en el botón de "Editar".
     * @param {Event} event - El evento de clic.
     */
    async function handleEditClick(event) {
        currentMode = 'edit';
        currentMedicoId = event.currentTarget.dataset.id;
        medicoModalLabel.textContent = 'Editar Médico';

        try {
            const response = await axios.get(`${API_BASE_URL}${currentMedicoId}/`);
            const medico = response.data;
            nombreInput.value = medico.nombre;
            apellidoInput.value = medico.apellido;
            rutInput.value = medico.rut;
            correoInput.value = medico.correo;
            telefonoInput.value = medico.telefono;
            especialidadSelect.value = medico.especialidad; // Asigna el ID de la especialidad
            activoCheckbox.checked = medico.activo;
            medicoIdInput.value = medico.id;
        } catch (error) {
            console.error('Error al cargar datos de médico para editar:', error);
            alert('Error al cargar los datos del médico.');
        }
    }

    /**
     * @brief Maneja el clic en el botón de "Eliminar".
     * @param {Event} event - El evento de clic.
     */
    async function handleDeleteClick(event) {
        const id = event.currentTarget.dataset.id;
        if (confirm(`¿Estás seguro de que quieres eliminar al médico con ID ${id}?`)) {
            try {
                await axios.delete(`${API_BASE_URL}${id}/`);
                alert('Médico eliminado correctamente.');
                loadMedicos({
                    search: searchInput.value,
                    especialidad: filterEspecialidadSelect.value,
                    activo: filterActivoSelect.value !== '' ? filterActivoSelect.value : null
                }); // Recargar la tabla con filtros actuales
            } catch (error) {
                console.error('Error al eliminar médico:', error);
                alert('Error al eliminar el médico. Podría tener consultas asignadas.');
            }
        }
    }

    /**
     * @brief Maneja el envío del formulario para crear o actualizar un médico.
     * @param {Event} event - El evento de envío del formulario.
     */
    medicoForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const data = {
            nombre: nombreInput.value,
            apellido: apellidoInput.value,
            rut: rutInput.value,
            correo: correoInput.value,
            telefono: telefonoInput.value,
            especialidad: especialidadSelect.value,
            activo: activoCheckbox.checked,
        };

        try {
            if (currentMode === 'create') {
                await axios.post(API_BASE_URL, data);
                alert('Médico creado correctamente.');
            } else { // currentMode === 'edit'
                await axios.put(`${API_BASE_URL}${currentMedicoId}/`, data);
                alert('Médico actualizado correctamente.');
            }
            medicoModal.hide();
            medicoForm.reset();
            loadMedicos({
                search: searchInput.value,
                especialidad: filterEspecialidadSelect.value,
                activo: filterActivoSelect.value !== '' ? filterActivoSelect.value : null
            }); // Recargar la tabla con filtros actuales
        } catch (error) {
            console.error('Error al guardar médico:', error.response ? error.response.data : error.message);
            const errorMessage = error.response && error.response.data ? JSON.stringify(error.response.data) : 'Error desconocido';
            alert(`Error al guardar el médico: ${errorMessage}`);
        }
    });

    /**
     * @brief Reinicia el formulario y el modo del modal al abrirlo en modo "crear".
     */
    document.getElementById('medicoModal').addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const mode = button.getAttribute('data-mode');

        if (mode === 'create') {
            currentMode = 'create';
            currentMedicoId = null;
            medicoModalLabel.textContent = 'Crear Nuevo Médico';
            medicoForm.reset();
            medicoIdInput.value = '';
            activoCheckbox.checked = true; // Por defecto activo
            especialidadSelect.value = ''; // Resetear el select de especialidad
        }
    });

    // Manejar la búsqueda
    searchButton.addEventListener('click', () => {
        loadMedicos({
            search: searchInput.value,
            especialidad: filterEspecialidadSelect.value,
            activo: filterActivoSelect.value !== '' ? filterActivoSelect.value : null
        });
    });

    searchInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            loadMedicos({
                search: searchInput.value,
                especialidad: filterEspecialidadSelect.value,
                activo: filterActivoSelect.value !== '' ? filterActivoSelect.value : null
            });
        }
    });

    // Manejar la aplicación de filtros
    applyFiltersButton.addEventListener('click', () => {
        loadMedicos({
            search: searchInput.value,
            especialidad: filterEspecialidadSelect.value,
            activo: filterActivoSelect.value !== '' ? filterActivoSelect.value : null
        });
    });


    // Cargar especialidades y médicos al inicio
    document.addEventListener('DOMContentLoaded', () => {
        loadEspecialidadesForSelects();
        loadMedicos();
    });
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}