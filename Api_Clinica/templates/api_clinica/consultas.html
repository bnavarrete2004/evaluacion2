{% extends 'api_clinica/base.html' %}

{% block title %}Consultas Médicas - {{ block.super }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Gestión de Consultas Médicas</h5>
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#consultaModal" data-mode="create">
                    <i class="fas fa-plus-circle me-2"></i>Nueva Consulta
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div class="d-flex">
                        <label for="filterPaciente" class="form-label me-2 mb-0 align-self-center">Filtrar por Paciente:</label>
                        <select class="form-select me-2" id="filterPaciente" style="width: 200px;">
                            <option value="">Todos</option>
                            <!-- Opciones de pacientes se cargarán aquí -->
                        </select>
                        <label for="filterMedico" class="form-label me-2 mb-0 align-self-center">Filtrar por Médico:</label>
                        <select class="form-select me-2" id="filterMedico" style="width: 200px;">
                            <option value="">Todos</option>
                            <!-- Opciones de médicos se cargarán aquí -->
                        </select>
                        <label for="filterEstado" class="form-label me-2 mb-0 align-self-center">Estado:</label>
                        <select class="form-select me-2" id="filterEstado" style="width: 150px;">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Completada">Completada</option>
                            <option value="Cancelada">Cancelada</option>
                        </select>
                        <button class="btn btn-primary" type="button" id="applyFiltersButton">Aplicar Filtros</button>
                    </div>
                    <div class="input-group w-25">
                        <input type="text" class="form-control" id="searchInput" placeholder="Buscar por motivo, diagnóstico...">
                        <button class="btn btn-primary" type="button" id="searchButton">Buscar</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Paciente</th>
                                <th>Médico</th>
                                <th>Fecha</th>
                                <th>Motivo</th>
                                <th>Estado</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="consultasTableBody">
                            <!-- Los datos se cargarán aquí con JavaScript -->
                            <tr>
                                <td colspan="7" class="text-center">Cargando consultas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear/Editar Consulta -->
<div class="modal fade" id="consultaModal" tabindex="-1" aria-labelledby="consultaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="consultaModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="consultaForm">
                    <input type="hidden" id="consultaId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="paciente" class="form-label">Paciente</label>
                            <select class="form-select" id="paciente" name="paciente" required>
                                <!-- Opciones de pacientes se cargarán aquí -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="medico" class="form-label">Médico</label>
                            <select class="form-select" id="medico" name="medico" required>
                                <!-- Opciones de médicos se cargarán aquí -->
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaConsulta" class="form-label">Fecha de Consulta</label>
                            <input type="datetime-local" class="form-control" id="fechaConsulta" name="fecha_consulta" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="estado" class="form-label">Estado</label>
                            <select class="form-select" id="estado" name="estado" required>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Completada">Completada</option>
                                <option value="Cancelada">Cancelada</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="motivo" class="form-label">Motivo</label>
                        <textarea class="form-control" id="motivo" name="motivo" rows="2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="diagnostico" class="form-label">Diagnóstico</label>
                        <textarea class="form-control" id="diagnostico" name="diagnostico" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="notas" class="form-label">Notas Adicionales</label>
                        <textarea class="form-control" id="notas" name="notas" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="consultaForm" class="btn btn-primary" id="saveConsultaBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const API_BASE_URL = '/api/consultas/';
    const PACIENTES_API_URL = '/api/pacientes/';
    const MEDICOS_API_URL = '/api/medicos/';

    const consultasTableBody = document.getElementById('consultasTableBody');
    const consultaModal = new bootstrap.Modal(document.getElementById('consultaModal'));
    const consultaModalLabel = document.getElementById('consultaModalLabel');
    const consultaForm = document.getElementById('consultaForm');
    const consultaIdInput = document.getElementById('consultaId');
    const pacienteSelect = document.getElementById('paciente');
    const medicoSelect = document.getElementById('medico');
    const fechaConsultaInput = document.getElementById('fechaConsulta');
    const estadoSelect = document.getElementById('estado');
    const motivoInput = document.getElementById('motivo');
    const diagnosticoInput = document.getElementById('diagnostico');
    const notasInput = document.getElementById('notas');
    const saveConsultaBtn = document.getElementById('saveConsultaBtn');

    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const filterPacienteSelect = document.getElementById('filterPaciente');
    const filterMedicoSelect = document.getElementById('filterMedico');
    const filterEstadoSelect = document.getElementById('filterEstado');
    const applyFiltersButton = document.getElementById('applyFiltersButton');

    let currentMode = 'create';
    let currentConsultaId = null;

    /**
     * @brief Carga pacientes y médicos para los selectores del formulario y filtro.
     */
    async function loadForeignKeysForSelects() {
        try {
            const [pacientesResponse, medicosResponse] = await Promise.all([
                axios.get(PACIENTES_API_URL),
                axios.get(MEDICOS_API_URL)
            ]);

            const pacientes = pacientesResponse.data;
            const medicos = medicosResponse.data;

            // Limpiar y poblar select de pacientes (formulario y filtro)
            pacienteSelect.innerHTML = '<option value="">Seleccione un paciente</option>';
            filterPacienteSelect.innerHTML = '<option value="">Todos</option>';
            pacientes.forEach(p => {
                const optionForm = document.createElement('option');
                optionForm.value = p.id;
                optionForm.textContent = `${p.nombre} ${p.apellido} (${p.rut})`;
                pacienteSelect.appendChild(optionForm);

                const optionFilter = document.createElement('option');
                optionFilter.value = p.id;
                optionFilter.textContent = `${p.nombre} ${p.apellido}`;
                filterPacienteSelect.appendChild(optionFilter);
            });

            // Limpiar y poblar select de médicos (formulario y filtro)
            medicoSelect.innerHTML = '<option value="">Seleccione un médico</option>';
            filterMedicoSelect.innerHTML = '<option value="">Todos</option>';
            medicos.forEach(m => {
                const optionForm = document.createElement('option');
                optionForm.value = m.id;
                optionForm.textContent = `${m.nombre} ${m.apellido} (${m.especialidad_nombre})`;
                medicoSelect.appendChild(optionForm);

                const optionFilter = document.createElement('option');
                optionFilter.value = m.id;
                optionFilter.textContent = `${m.nombre} ${m.apellido}`;
                filterMedicoSelect.appendChild(optionFilter);
            });

        } catch (error) {
            console.error('Error al cargar pacientes o médicos:', error);
            alert('Error al cargar la lista de pacientes o médicos.');
        }
    }

    /**
     * @brief Carga las consultas médicas desde la API y las renderiza en la tabla.
     * @param {object} filters - Objeto con filtros para la API.
     */
    async function loadConsultas(filters = {}) {
        try {
            let url = API_BASE_URL;
            const params = new URLSearchParams();
            if (filters.search) params.append('search', filters.search);
            if (filters.paciente) params.append('paciente', filters.paciente);
            if (filters.medico) params.append('medico', filters.medico);
            if (filters.estado) params.append('estado', filters.estado);

            if (params.toString()) {
                url += `?${params.toString()}`;
            }

            const response = await axios.get(url);
            const consultas = response.data;
            renderConsultas(consultas);
        } catch (error) {
            console.error('Error al cargar consultas:', error);
            consultasTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error al cargar las consultas.</td></tr>`;
        }
    }

    /**
     * @brief Renderiza la lista de consultas en la tabla HTML.
     * @param {Array} consultas - Lista de objetos de consulta médica.
     */
    function renderConsultas(consultas) {
        consultasTableBody.innerHTML = '';
        if (consultas.length === 0) {
            consultasTableBody.innerHTML = `<tr><td colspan="7" class="text-center">No hay consultas registradas.</td></tr>`;
            return;
        }
        consultas.forEach(consulta => {
            const row = consultasTableBody.insertRow();
            // Formatear la fecha para que sea legible
            const fechaHora = new Date(consulta.fecha_consulta).toLocaleString('es-CL', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            let estadoBadgeClass = '';
            switch (consulta.estado) {
                case 'Pendiente':
                    estadoBadgeClass = 'bg-warning text-dark';
                    break;
                case 'Completada':
                    estadoBadgeClass = 'bg-success';
                    break;
                case 'Cancelada':
                    estadoBadgeClass = 'bg-danger';
                    break;
                default:
                    estadoBadgeClass = 'bg-secondary';
            }

            row.innerHTML = `
                <td>${consulta.id}</td>
                <td>${consulta.paciente_nombre_completo || 'N/A'}</td>
                <td>${consulta.medico_nombre_completo || 'N/A'}</td>
                <td>${fechaHora}</td>
                <td>${consulta.motivo.substring(0, 50)}...</td>
                <td><span class="badge ${estadoBadgeClass}">${consulta.estado}</span></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-info text-white me-2 edit-btn" data-id="${consulta.id}" data-bs-toggle="modal" data-bs-target="#consultaModal" data-mode="edit">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="${consulta.id}">
                        <i class="fas fa-trash-alt"></i> Eliminar
                    </button>
                </td>
            `;
        });

        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', handleEditClick);
        });
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', handleDeleteClick);
        });
    }

    /**
     * @brief Maneja el clic en el botón de "Editar".
     * @param {Event} event - El evento de clic.
     */
    async function handleEditClick(event) {
        currentMode = 'edit';
        currentConsultaId = event.currentTarget.dataset.id;
        consultaModalLabel.textContent = 'Editar Consulta Médica';

        try {
            const response = await axios.get(`${API_BASE_URL}${currentConsultaId}/`);
            const consulta = response.data;

            pacienteSelect.value = consulta.paciente;
            medicoSelect.value = consulta.medico;
            // Formatear la fecha para el input datetime-local (YYYY-MM-DDTHH:MM)
            fechaConsultaInput.value = new Date(consulta.fecha_consulta).toISOString().slice(0, 16);
            estadoSelect.value = consulta.estado;
            motivoInput.value = consulta.motivo;
            diagnosticoInput.value = consulta.diagnostico;
            notasInput.value = consulta.notas;
            consultaIdInput.value = consulta.id;
        } catch (error) {
            console.error('Error al cargar datos de consulta para editar:', error);
            alert('Error al cargar los datos de la consulta.');
        }
    }

    /**
     * @brief Maneja el clic en el botón de "Eliminar".
     * @param {Event} event - El evento de clic.
     */
    async function handleDeleteClick(event) {
        const id = event.currentTarget.dataset.id;
        if (confirm(`¿Estás seguro de que quieres eliminar la consulta con ID ${id}?`)) {
            try {
                await axios.delete(`${API_BASE_URL}${id}/`);
                alert('Consulta eliminada correctamente.');
                loadConsultas({
                    search: searchInput.value,
                    paciente: filterPacienteSelect.value,
                    medico: filterMedicoSelect.value,
                    estado: filterEstadoSelect.value
                });
            } catch (error) {
                console.error('Error al eliminar consulta:', error);
                alert('Error al eliminar la consulta.');
            }
        }
    }

    /**
     * @brief Maneja el envío del formulario para crear o actualizar una consulta.
     * @param {Event} event - El evento de envío del formulario.
     */
    consultaForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const data = {
            paciente: pacienteSelect.value,
            medico: medicoSelect.value,
            fecha_consulta: fechaConsultaInput.value,
            estado: estadoSelect.value,
            motivo: motivoInput.value,
            diagnostico: diagnosticoInput.value,
            notas: notasInput.value,
        };

        try {
            if (currentMode === 'create') {
                await axios.post(API_BASE_URL, data);
                alert('Consulta creada correctamente.');
            } else { // currentMode === 'edit'
                await axios.put(`${API_BASE_URL}${currentConsultaId}/`, data);
                alert('Consulta actualizada correctamente.');
            }
            consultaModal.hide();
            consultaForm.reset();
            loadConsultas({
                search: searchInput.value,
                paciente: filterPacienteSelect.value,
                medico: filterMedicoSelect.value,
                estado: filterEstadoSelect.value
            });
        } catch (error) {
            console.error('Error al guardar consulta:', error.response ? error.response.data : error.message);
            const errorMessage = error.response && error.response.data ? JSON.stringify(error.response.data) : 'Error desconocido';
            alert(`Error al guardar la consulta: ${errorMessage}`);
        }
    });

    /**
     * @brief Reinicia el formulario y el modo del modal al abrirlo en modo "crear".
     */
    document.getElementById('consultaModal').addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const mode = button.getAttribute('data-mode');

        if (mode === 'create') {
            currentMode = 'create';
            currentConsultaId = null;
            consultaModalLabel.textContent = 'Crear Nueva Consulta Médica';
            consultaForm.reset();
            consultaIdInput.value = '';
            // Establecer valores por defecto si es necesario para campos select o checkboxes
            pacienteSelect.value = '';
            medicoSelect.value = '';
            estadoSelect.value = 'Pendiente'; // Por defecto
            fechaConsultaInput.value = new Date().toISOString().slice(0, 16); // Fecha y hora actual por defecto
        }
    });

    // Manejar la búsqueda
    searchButton.addEventListener('click', () => {
        loadConsultas({
            search: searchInput.value,
            paciente: filterPacienteSelect.value,
            medico: filterMedicoSelect.value,
            estado: filterEstadoSelect.value
        });
    });

    searchInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            loadConsultas({
                search: searchInput.value,
                paciente: filterPacienteSelect.value,
                medico: filterMedicoSelect.value,
                estado: filterEstadoSelect.value
            });
        }
    });

    // Manejar la aplicación de filtros
    applyFiltersButton.addEventListener('click', () => {
        loadConsultas({
            search: searchInput.value,
            paciente: filterPacienteSelect.value,
            medico: filterMedicoSelect.value,
            estado: filterEstadoSelect.value
        });
    });


    // Cargar pacientes, médicos y consultas al inicio
    document.addEventListener('DOMContentLoaded', () => {
        loadForeignKeysForSelects();
        loadConsultas();
    });
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}